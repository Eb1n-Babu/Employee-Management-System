{% extends 'base.html' %}
{% load dict_tags %}

{% block title %}
    {% if employee %}Edit Employee{% else %}Create Employee{% endif %}
{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">
    {% if employee %}Edit Employee{% else %}Create Employee{% endif %}
</h1>

<form method="POST" class="space-y-4" id="employeeForm">
    {% csrf_token %}

    <!-- Static model fields from EmployeeForm -->
    <div class="form-group">
        {{ form.first_name.label_tag }} {{ form.first_name }}
    </div>
    <div class="form-group">
        {{ form.last_name.label_tag }} {{ form.last_name }}
    </div>
    <div class="form-group">
        {{ form.email.label_tag }} {{ form.email }}
    </div>
    <div class="form-group">
        {{ form.phone.label_tag }} {{ form.phone }}
    </div>
    <div class="form-group">
        {{ form.address.label_tag }} {{ form.address }}
    </div>
    <div class="form-group">
        {{ form.role.label_tag }} {{ form.role }}
    </div>
    <div class="form-group">
        {{ form.designation.label_tag }} {{ form.designation }}
    </div>
    <div class="form-group">
        {{ form.reporting_manager.label_tag }} {{ form.reporting_manager }}
    </div>

    <!-- Dynamic fields from FormField model -->
    {% for field in fields %}
    <div class="form-group">
        <label for="{{ field.label }}">{{ field.label }}{% if field.is_required %}*{% endif %}</label>
        {% if field.field_type == 'select' %}
            <select name="{{ field.label }}" id="{{ field.label }}" class="border rounded p-2" {% if field.is_required %}required{% endif %}>
                {% for option in field.options %}
                    <option value="{{ option }}" {% if data|get:field.label == option %}selected{% endif %}>
                        {{ option }}
                    </option>
                {% endfor %}
            </select>
        {% elif field.field_type == 'date' %}
            <input type="date" name="{{ field.label }}" id="{{ field.label }}"
                value="{{ data|get:field.label }}" class="border rounded p-2" {% if field.is_required %}required{% endif %}>
        {% else %}
            <input type="{{ field.field_type }}" name="{{ field.label }}" id="{{ field.label }}"
                value="{{ data|get:field.label }}" class="border rounded p-2" {% if field.is_required %}required{% endif %}>
        {% endif %}
    </div>
    {% endfor %}

    <button type="submit" class="submit-btn">
        {% if employee %}Update{% else %}Create{% endif %}
    </button>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('employeeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    try {
        const response = await fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        const data = await response.json();
        if (data.success) {
            window.location.href = '{% url "employee_list" %}';
        } else {
            alert('Error: ' + JSON.stringify(data.errors));
        }
    } catch (error) {
        alert('An error occurred: ' + error.message);
    }
});
</script>
{% endblock %}