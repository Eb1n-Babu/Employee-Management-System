{% extends 'base.html' %}

{% block title %}
    {{ form_heading|default:"Form Designer" }}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h2 class="text-2xl font-bold mb-4">üõ†Ô∏è {{ form_heading|default:"Design Your Form" }}</h2>

    <!-- Field Input Section -->
    <div class="flex gap-4 mb-6">
        <input type="text" id="fieldLabel" placeholder="Field Label" class="border p-2 rounded w-1/3">
        <select id="fieldType" class="border p-2 rounded w-1/4">
            <option value="text">Text</option>
            <option value="email">Email</option>
            <option value="textarea">Textarea</option>
            <option value="number">Number</option>
            <option value="date">Date</option>
            <option value="select">Dropdown</option>
        </select>
        <input type="checkbox" id="fieldRequired" class="mr-2">
        <label for="fieldRequired">Required</label>
        <input type="text" id="fieldOptions" placeholder="Dropdown options (comma-separated)" class="border p-2 rounded w-1/3" style="display: none;">
        <button onclick="addField()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add Field</button>
    </div>

    <!-- Field List -->
    <ul id="field-list" class="mb-6"></ul>

    <!-- Save Button -->
    <button onclick="saveFields()" class="bg-green-600 text-white px-4 py-2 rounded mb-8 hover:bg-green-700">üíæ Save Form Design</button>

    <!-- Form Preview -->
    <form id="formPreview" class="space-y-4">
        <!-- Dynamic Fields Only -->
        {% for field in dynamic_fields %}
            <div class="form-group">
                <label class="block font-medium mb-1" for="{{ field.name }}">{{ field.label }}{% if field.required %}*{% endif %}</label>
                {% if field.type == 'select' %}
                    <select name="{{ field.name }}" id="{{ field.name }}" class="border p-2 rounded w-full" {% if field.required %}required{% endif %}>
                        <option value="">Select {{ field.label }}</option>
                        {% for option in field.options %}
                            <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                {% elif field.type == 'textarea' %}
                    <textarea name="{{ field.name }}" id="{{ field.name }}" class="border p-2 rounded w-full" {% if field.required %}required{% endif %}></textarea>
                {% elif field.type == 'date' %}
                    <input type="date" name="{{ field.name }}" id="{{ field.name }}"
                           class="border p-2 rounded w-full" {% if field.required %}required{% endif %}>
                {% else %}
                    <input type="{{ field.type }}" name="{{ field.name }}" id="{{ field.name }}"
                           class="border p-2 rounded w-full" {% if field.required %}required{% endif %}>
                {% endif %}
            </div>
        {% endfor %}
    </form>
</div>

<script>
    // List of default fields to prevent conflicts
    const defaultFields = [
        'first_name',
        'last_name',
        'email',
        'phone',
        'address',
        'role',
        'designation',
        'reporting_manager'
    ];

    // Initialize fields array with only dynamic fields
    let fields = [
        {% for field in dynamic_fields %}
            {
                name: "{{ field.name }}",
                label: "{{ field.label }}",
                type: "{{ field.type }}",
                required: {{ field.required|lower }},
                options: {{ field.options|safe }}
            },
        {% endfor %}
    ];

    document.getElementById('fieldType').addEventListener('change', function() {
        const optionsInput = document.getElementById('fieldOptions');
        optionsInput.style.display = this.value === 'select' ? 'block' : 'none';
    });

    function addField() {
        const label = document.getElementById('fieldLabel').value;
        const type = document.getElementById('fieldType').value;
        const required = document.getElementById('fieldRequired').checked;
        const optionsInput = document.getElementById('fieldOptions').value;
        const options = type === 'select' && optionsInput ? optionsInput.split(',').map(opt => opt.trim()) : [];

        if (!label || !type) {
            alert("Please enter a label and select a type");
            return;
        }

        const fieldName = label.toLowerCase().replace(/\s+/g, '_');

        // Prevent adding a field with a name that matches a default field
        if (defaultFields.includes(fieldName)) {
            alert("Field name conflicts with a default field. Please choose a different label.");
            return;
        }

        // Prevent duplicate dynamic field names
        if (fields.some(field => field.name === fieldName)) {
            alert("A field with this name already exists. Please choose a different label.");
            return;
        }

        fields.push({ name: fieldName, label: label, type: type, required: required, options: options });

        // Add to field list
        const li = document.createElement('li');
        li.setAttribute('data-name', fieldName);
        li.innerHTML = `
            ${label} (${type})${required ? ' (Required)' : ''}${options.length ? ' Options: ' + options.join(', ') : ''}
            <button onclick="removeField('${fieldName}')" class="text-red-500 ml-2">Remove</button>
        `;
        document.getElementById('field-list').appendChild(li);

        // Add to preview
        const formPreview = document.getElementById('formPreview');
        const div = document.createElement('div');
        div.className = 'form-group';
        let inputHtml = '';
        if (type === 'select') {
            inputHtml = `<select name="${fieldName}" id="${fieldName}" class="border p-2 rounded w-full" ${required ? 'required' : ''}>`;
            inputHtml += `<option value="">Select ${label}</option>`;
            options.forEach(opt => {
                inputHtml += `<option value="${opt}">${opt}</option>`;
            });
            inputHtml += '</select>';
        } else if (type === 'textarea') {
            inputHtml = `<textarea name="${fieldName}" id="${fieldName}" class="border p-2 rounded w-full" ${required ? 'required' : ''}></textarea>`;
        } else if (type === 'date') {
            inputHtml = `<input type="date" name="${fieldName}" id="${fieldName}" class="border p-2 rounded w-full" ${required ? 'required' : ''}>`;
        } else {
            inputHtml = `<input type="${type}" name="${fieldName}" id="${fieldName}" class="border p-2 rounded w-full" ${required ? 'required' : ''}>`;
        }
        div.innerHTML = `
            <label class="block font-medium mb-1" for="${fieldName}">${label}${required ? '*' : ''}</label>
            ${inputHtml}
        `;
        formPreview.appendChild(div);

        document.getElementById('fieldLabel').value = '';
        document.getElementById('fieldRequired').checked = false;
        document.getElementById('fieldOptions').value = '';
        document.getElementById('fieldOptions').style.display = 'none';
    }

    function removeField(fieldName) {
        fields = fields.filter(field => field.name !== fieldName);
        document.querySelector(`li[data-name="${fieldName}"]`).remove();
        document.querySelector(`#formPreview [name="${fieldName}"]`).parentElement.remove();
    }

    async function saveFields() {
        const extraFields = fields.reduce((acc, field) => {
            acc[field.name] = {
                type: field.type,
                label: field.label,
                required: field.required,
                options: field.options || []
            };
            return acc;
        }, {});

        const payload = {
            heading: "{{ form_heading|default:'Custom Employee Form' }}",
            extra_fields: extraFields,
            form_data: {}
        };

        try {
            const response = await fetch("{% url 'form-design' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert('Error: ' + JSON.stringify(data.message || data.errors));
            }
        } catch (error) {
            alert('An error occurred: ' + error.message);
        }
    }
</script>

<style>
    #field-list {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 4px;
    }
    #field-list li {
        padding: 5px;
        margin: 5px 0;
        background-color: #f9f9f9;
        display: flex;
        justify-content: space-between;
    }
    .form-group {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}