{% extends 'base.html' %}

{% block title %}
    {{ form_heading|default:"Form Designer" }}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h2 class="text-2xl font-bold mb-4">üõ†Ô∏è {{ form_heading|default:"Design Your Form" }}</h2>

    <!-- Field Input Section -->
    <div class="flex gap-4 mb-6">
        <input type="text" id="fieldLabel" placeholder="Field Label"
               class="border p-2 rounded w-1/2">
        <select id="fieldType" class="border p-2 rounded w-1/3">
            <option value="text">Text</option>
            <option value="email">Email</option>
            <option value="textarea">Textarea</option>
            <option value="number">Number</option>
        </select>
        <input type="checkbox" id="fieldRequired" class="mr-2">
        <label for="fieldRequired">Required</label>
        <button onclick="addField()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add Field</button>
    </div>

    <!-- Field List -->
    <ul id="field-list" class="mb-6 list-disc pl-5">
        {% for field in form_fields %}
            <li data-name="{{ field.name }}">{{ field.label }} ({{ field.type }}) {% if field.required %}(Required){% endif %}</li>
        {% endfor %}
    </ul>

    <!-- Save Button -->
    <button onclick="saveFields()" class="bg-green-600 text-white px-4 py-2 rounded mb-8 hover:bg-green-700">üíæ Save Form Design</button>

    <!-- Form Preview -->
    <form id="formPreview" class="space-y-4">
        <!-- Standard EmployeeForm Fields -->
        {% for field in form_fields %}
            {% if field.name in 'first_name,last_name,email,phone,address,role,designation,reporting_manager' %}
                <div class="form-group">
                    <label class="block font-medium mb-1" for="{{ field.name }}">{{ field.label }}{% if field.required %}*{% endif %}</label>
                    {% if field.type == 'select' %}
                        <select name="{{ field.name }}" id="{{ field.name }}" class="border p-2 rounded w-full" {% if field.required %}required{% endif %}>
                            {% if field.name == 'role' %}
                                {% for value, label in form.ROLE_CHOICES %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            {% elif field.name == 'designation' %}
                                {% for value, label in form.DESIGNATION_CHOICES %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            {% elif field.name == 'reporting_manager' %}
                                {% for manager in form.reporting_manager.queryset %}
                                    <option value="{{ manager.pk }}">{{ manager }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    {% elif field.type == 'textarea' %}
                        <textarea name="{{ field.name }}" id="{{ field.name }}" class="border p-2 rounded w-full" {% if field.required %}required{% endif %}></textarea>
                    {% else %}
                        <input type="{{ field.type }}" name="{{ field.name }}" id="{{ field.name }}"
                               class="border p-2 rounded w-full" {% if field.required %}required{% endif %}>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}

        <!-- Dynamic Fields -->
        {% for field in form_fields %}
            {% if field.name not in 'first_name,last_name,email,phone,address,role,designation,reporting_manager' %}
                <div class="form-group">
                    <label class="block font-medium mb-1" for="{{ field.name }}">{{ field.label }}{% if field.required %}*{% endif %}</label>
                    {% if field.type == 'textarea' %}
                        <textarea name="{{ field.name }}" id="{{ field.name }}" class="border p-2 rounded w-full" {% if field.required %}required{% endif %}></textarea>
                    {% else %}
                        <input type="{{ field.type }}" name="{{ field.name }}" id="{{ field.name }}"
                               class="border p-2 rounded w-full" {% if field.required %}required{% endif %}>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    </form>
</div>

<script>
    let fields = [
        {% for field in form_fields %}
            {
                name: "{{ field.name }}",
                label: "{{ field.label }}",
                type: "{{ field.type }}",
                required: {{ field.required|lower }}
            },
        {% endfor %}
    ];

    function addField() {
        const label = document.getElementById('fieldLabel').value;
        const type = document.getElementById('fieldType').value;
        const required = document.getElementById('fieldRequired').checked;

        if (!label || !type) {
            alert("Please enter a label and select a type");
            return;
        }

        const fieldName = label.toLowerCase().replace(/\s+/g, '_');
        fields.push({ name: fieldName, label: label, type: type, required: required });

        const li = document.createElement('li');
        li.setAttribute('data-name', fieldName);
        li.textContent = `${label} (${type})${required ? ' (Required)' : ''}`;
        document.getElementById('field-list').appendChild(li);

        // Add to preview
        const formPreview = document.getElementById('formPreview');
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label class="block font-medium mb-1" for="${fieldName}">${label}${required ? '*' : ''}</label>
            ${type === 'textarea' ?
                `<textarea name="${fieldName}" id="${fieldName}" class="border p-2 rounded w-full" ${required ? 'required' : ''}></textarea>` :
                `<input type="${type}" name="${fieldName}" id="${fieldName}" class="border p-2 rounded w-full" ${required ? 'required' : ''}>`}
        `;
        formPreview.appendChild(div);

        document.getElementById('fieldLabel').value = '';
        document.getElementById('fieldRequired').checked = false;
    }

    async function saveFields() {
        const extraFields = fields.reduce((acc, field) => {
            acc[field.name] = {
                type: field.type,
                label: field.label,
                required: field.required
            };
            return acc;
        }, {});

        const payload = {
            heading: "{{ form_heading|default:'Custom Employee Form' }}",
            extra_fields: extraFields,
            form_data: {}
        };

        try {
            const response = await fetch("{% url 'form-design' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert('Error: ' + JSON.stringify(data.errors));
            }
        } catch (error) {
            alert('An error occurred: ' + error.message);
        }
    }
</script>
{% endblock %}